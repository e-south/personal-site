---
/*
--------------------------------------------------------------------------------
personal-site
src/components/home/StoryChapters.astro

Renders the narrative chapter sections and their media carousels.

Module Author(s): Eric J. South
--------------------------------------------------------------------------------
*/

import type { CollectionEntry } from 'astro:content';
import StoryMediaItem from '@/components/home/StoryMediaItem.astro';
import Prose from '@/components/ui/Prose.astro';
import type { StoryRegistry } from '@/data/storyMedia';
import { buildStoryChapters } from '@/lib/story';
import { isSafeExternalHref, sanitizeHref } from '@/lib/urls';
import '@/styles/story-chapters.css';

type Props = {
  chapters: CollectionEntry<'story'>[];
  registry: StoryRegistry;
};

const { chapters, registry } = Astro.props as Props;

const chapterItems = await buildStoryChapters({ chapters, registry });

const chapterCount = chapterItems.length;
---

<section id="about" class="space-y-16" data-story-snap>
  {
    chapterItems.map((chapter, chapterIndex) => {
      const prevChapter = chapterItems[chapterIndex - 1];
      const prevHref = prevChapter ? `#${prevChapter.id}` : '#page-top';
      const prevLabel = prevChapter ? 'Previous chapter' : 'Back to top';
      const prevNavLabel = prevChapter
        ? `Go to ${prevChapter.title}`
        : 'Back to top';
      const nextChapter = chapterItems[chapterIndex + 1];
      const nextHref = nextChapter ? `#${nextChapter.id}` : '#page-top';
      const nextLabel = nextChapter ? 'Next chapter' : 'Back to top';
      const navLabel = nextChapter
        ? `Go to ${nextChapter.title}`
        : 'Back to top';
      const chapterLabel = `${String(chapterIndex + 1).padStart(2, '0')} / ${String(chapterCount).padStart(2, '0')}`;
      const ctaHref = chapter.ctaHref ? sanitizeHref(chapter.ctaHref) : '';
      const ctaExternal = ctaHref ? isSafeExternalHref(ctaHref) : false;

      return (
        <section
          id={chapter.id}
          class="story-chapter glass-card section-divider-bottom px-5 py-12 sm:px-6 sm:py-14 lg:px-8 lg:py-16"
          data-story-chapter
          data-reveal
        >
          <div
            class:list={[
              'grid gap-10 lg:items-start',
              chapter.media.length > 0
                ? 'lg:grid-cols-[minmax(0,1fr)_minmax(0,1fr)]'
                : 'lg:grid-cols-1',
            ]}
          >
            <div class="space-y-6">
              <div class="space-y-3">
                <p class="text-[0.65rem] uppercase tracking-[0.35em] text-base-content/50">
                  Chapter {chapterLabel}
                </p>
                <h2 class="story-chapter-title text-3xl font-semibold tracking-tight sm:text-4xl">
                  {chapter.title}
                </h2>
              </div>
              <Prose class="prose-p:text-base-content/80 text-justify">
                <chapter.Content />
              </Prose>
              {chapter.ctaLabel && ctaHref && (
                <div>
                  <a
                    class="focus-ring story-chapter-cta inline-flex items-center gap-2 rounded-[var(--site-radius-control)] px-4 py-2 text-xs uppercase tracking-[0.25em] text-base-content/80"
                    href={ctaHref}
                    target={ctaExternal ? '_blank' : undefined}
                    rel={ctaExternal ? 'noreferrer noopener' : undefined}
                  >
                    {chapter.ctaLabel}
                  </a>
                </div>
              )}
            </div>
            {chapter.media.length > 0 && (
              <div class="space-y-4">
                {chapter.media.length === 1 ? (
                  <div class="story-media-single">
                    {chapter.media.map((item, mediaIndex) => {
                      const eagerBase = chapterIndex === 0 && mediaIndex === 0;
                      return <StoryMediaItem item={item} eager={eagerBase} />;
                    })}
                  </div>
                ) : (
                  <div class="story-carousel-wrapper" data-carousel-wrapper>
                    <div
                      class="story-carousel"
                      data-carousel
                      id={`carousel-${chapter.id}`}
                      aria-label={`${chapter.title} media carousel`}
                    >
                      {chapter.media.map((item, mediaIndex) => {
                        const eagerBase =
                          chapterIndex === 0 && mediaIndex === 0;
                        return (
                          <div class="story-carousel-item" data-carousel-item>
                            <StoryMediaItem item={item} eager={eagerBase} />
                          </div>
                        );
                      })}
                    </div>
                    <div class="story-carousel-controls">
                      <button
                        type="button"
                        class="focus-ring story-carousel-button"
                        data-carousel-prev
                        aria-label={`Previous media for ${chapter.title}`}
                      >
                        Prev
                      </button>
                      <button
                        type="button"
                        class="focus-ring story-carousel-button"
                        data-carousel-next
                        aria-label={`Next media for ${chapter.title}`}
                      >
                        Next
                      </button>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
          <div class="mt-10 flex items-center justify-center">
            <div class="story-chapter-nav">
              <a
                href={prevHref}
                class="focus-ring story-nav-link"
                data-story-nav
                aria-label={prevNavLabel}
              >
                <svg
                  class="h-4 w-4 -rotate-90 transition-transform"
                  viewBox="0 0 24 24"
                  role="img"
                  aria-hidden="true"
                >
                  <path
                    d="M12 5l7 7-7 7-1.4-1.4 4.6-4.6H5v-2h10.2l-4.6-4.6L12 5z"
                    fill="currentColor"
                  />
                </svg>
                <span>{prevLabel}</span>
              </a>
              <a
                href={nextHref}
                class="focus-ring story-nav-link"
                data-story-nav
                aria-label={navLabel}
              >
                <span>{nextLabel}</span>
                <svg
                  class:list={[
                    'h-4 w-4 transition-transform',
                    { '-rotate-90': !nextChapter, 'rotate-90': nextChapter },
                  ]}
                  viewBox="0 0 24 24"
                  role="img"
                  aria-hidden="true"
                >
                  <path
                    d="M12 5l7 7-7 7-1.4-1.4 4.6-4.6H5v-2h10.2l-4.6-4.6L12 5z"
                    fill="currentColor"
                  />
                </svg>
              </a>
            </div>
          </div>
        </section>
      );
    })
  }
</section>
