---
import TagChip from '@/components/ui/TagChip.astro';
import PillLink from '@/components/ui/PillLink.astro';
import ProjectBanner from '@/components/projects/ProjectBanner.astro';
import type { ProjectCard as ProjectCardType } from '@/lib/content';

type Props = {
  project: ProjectCardType;
};

const { project } = Astro.props as Props;

const linkLabels: Record<string, string> = {
  repo: 'Code',
  live: 'Live',
  paper: 'Paper',
};

const cardBanners = project.banners ?? [];

const parseEmphasis = (text: string) =>
  text
    .split(/(\*[^*]+\*)/g)
    .filter(Boolean)
    .map((segment) => {
      const isEmphasis =
        segment.startsWith('*') && segment.endsWith('*') && segment.length > 2;
      return {
        content: isEmphasis ? segment.slice(1, -1) : segment,
        emphasis: isEmphasis,
      };
    });
---

<article
  class="project-card glass-card relative flex flex-col gap-5 rounded-2xl p-6"
>
  <a
    href={`#project-${project.slug}`}
    class="focus-ring project-card-jump"
    data-project-card-jump
    aria-label={`Jump to narrative for ${project.title}`}></a>

  <div class="space-y-2">
    <h2 class="text-2xl font-semibold">{project.title}</h2>
    <p class="text-base-content/80 leading-relaxed">
      {
        parseEmphasis(project.description).map((part) =>
          part.emphasis ? <em>{part.content}</em> : <span>{part.content}</span>,
        )
      }
    </p>
    {
      project.summary && (
        <p class="text-sm text-base-content/60">{project.summary}</p>
      )
    }
  </div>

  {
    project.tech.length > 0 && (
      <ul class="relative z-20 flex flex-wrap gap-2">
        {project.tech.map((tag) => (
          <li>
            <TagChip label={tag} size="xs" uppercase />
          </li>
        ))}
      </ul>
    )
  }

  {
    project.links && (
      <div class="relative z-20 flex flex-wrap gap-4 text-sm text-base-content/70 font-sans">
        {Object.entries(project.links).map(([key, href]) =>
          href ? (
            <PillLink href={href}>{linkLabels[key] ?? key}</PillLink>
          ) : null,
        )}
      </div>
    )
  }

  {
    cardBanners.map((banner) => (
      <div class="project-card-asset">
        <ProjectBanner banner={banner} />
      </div>
    ))
  }
</article>

<style>
  .project-card-jump {
    position: absolute;
    inset: 0;
    border-radius: inherit;
    z-index: 10;
  }

  .project-card-asset {
    position: relative;
    z-index: 20;
    pointer-events: none;
  }

  .project-card-asset * {
    pointer-events: none;
  }
</style>
