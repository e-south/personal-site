---
/*
--------------------------------------------------------------------------------
personal-site
src/components/projects/ProjectCarousel.astro

Renders the projects carousel with navigation controls.

Module Author(s): Eric J. South
--------------------------------------------------------------------------------
*/

import ProjectCarouselNav from '@/components/projects/ProjectCarouselNav.astro';
import ProjectPanel from '@/components/projects/ProjectPanel.astro';
import type { ProjectPanel as ProjectPanelType } from '@/lib/projects';

type Props = {
  projects: ProjectPanelType[];
  class?: string;
};

const { projects, class: className } = Astro.props as Props;

if (!Array.isArray(projects) || projects.length === 0) {
  throw new Error('Project carousel is missing projects.');
}

const classes = [
  'relative flex flex-col gap-4 project-carousel',
  className ?? '',
]
  .join(' ')
  .trim();

const projectMeta = projects.map((project) => {
  const slug = project.entry.slug;
  if (!slug) {
    throw new Error('Project entry slug is missing.');
  }
  return {
    id: `project-${slug}`,
    title: project.entry.data.title,
  };
});
---

<section
  class={classes}
  data-project-carousel
  aria-roledescription="carousel"
  aria-label="Projects carousel"
>
  <div class="project-carousel-frame relative">
    <div class="project-carousel-grid grid">
      <div
        class="pointer-events-none project-carousel-nav-layer col-start-1 row-start-1 z-10"
      >
        <div class="story-carousel-side">
          <button
            type="button"
            class="focus-ring pointer-events-auto project-carousel-button"
            data-carousel-prev
            aria-label="Previous project"
          >
            <svg
              class="project-carousel-button__icon project-carousel-button__icon--prev"
              viewBox="0 0 24 24"
              aria-hidden="true"
              focusable="false"
            >
              <path
                d="M14.5 6.5 9 12l5.5 5.5"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"></path>
            </svg>
            <span class="project-carousel-button__label">Prev</span>
          </button>
        </div>
      </div>
      <div
        class="pointer-events-none project-carousel-nav-layer col-start-1 row-start-1 z-10"
      >
        <div class="story-carousel-side story-carousel-side--right">
          <button
            type="button"
            class="focus-ring pointer-events-auto project-carousel-button project-carousel-button--next"
            data-carousel-next
            aria-label="Next project"
          >
            <svg
              class="project-carousel-button__icon project-carousel-button__icon--next"
              viewBox="0 0 24 24"
              aria-hidden="true"
              focusable="false"
            >
              <path
                d="M9.5 6.5 15 12l-5.5 5.5"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"></path>
            </svg>
            <span class="project-carousel-button__label">Next</span>
          </button>
        </div>
      </div>
      <div class="col-start-1 row-start-1">
        <div
          class="focus-ring project-carousel-track glass-card overflow-x-auto overflow-y-hidden overscroll-x-contain rounded-3xl"
          data-carousel-track
          tabindex="0"
          aria-label="Projects"
        >
          {
            projects.map((project, index) => (
              <ProjectPanel
                project={project}
                index={index}
                total={projects.length}
              />
            ))
          }
        </div>
      </div>
    </div>
  </div>

  <p class="project-carousel-hint" aria-hidden="true">Swipe to explore</p>

  <ProjectCarouselNav projects={projectMeta} position="bottom" />
</section>

<script>
  import { bindProjectCarousel } from '@/lib/projectCarouselRuntime';

  bindProjectCarousel();
</script>

<style>
  .project-carousel-frame {
    flex: 1 1 auto;
    min-height: 0;
    width: 100%;
    min-width: 0;
  }

  .project-carousel-grid {
    width: 100%;
    min-width: 0;
  }

  .project-carousel-track {
    display: grid;
    grid-auto-flow: column;
    grid-auto-columns: 100%;
    align-items: start;
    scroll-snap-type: x proximity;
    scroll-padding-inline: clamp(1rem, 4vw, 1.5rem);
    scrollbar-width: thin;
    scrollbar-color: color-mix(in oklab, var(--site-accent) 56%, transparent)
      color-mix(in oklab, var(--site-surface) 52%, transparent);
    -webkit-overflow-scrolling: touch;
    touch-action: pan-x pan-y;
    transition:
      height var(--project-carousel-height-transition-ms, 520ms)
        cubic-bezier(0.22, 1, 0.36, 1),
      opacity var(--project-carousel-swap-transition-ms, 180ms) ease,
      filter var(--project-carousel-swap-transition-ms, 180ms) ease;
    will-change: height;
  }

  .project-carousel-track.project-carousel-track--programmatic {
    scroll-snap-type: none;
  }

  .project-carousel-track--soft-swap {
    opacity: 0.84;
    filter: saturate(0.9);
  }

  .project-carousel-track::-webkit-scrollbar {
    height: 0.52rem;
  }

  .project-carousel-track::-webkit-scrollbar-track {
    background: color-mix(in oklab, var(--site-surface) 55%, transparent);
    border-radius: 999px;
  }

  .project-carousel-track::-webkit-scrollbar-thumb {
    background: color-mix(in oklab, var(--site-accent) 54%, transparent);
    border-radius: 999px;
  }

  @media (min-width: 768px) {
    .project-carousel-track {
      scroll-snap-type: x mandatory;
    }
  }

  .project-carousel-button {
    --control-height: 1.95rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
    padding: 0 0.68rem;
    min-height: var(--control-height);
    border-radius: var(--site-radius-control);
    border: 0;
    background: color-mix(in oklab, var(--site-surface) 72%, transparent);
    color: color-mix(in oklab, var(--site-text) 88%, transparent);
    font-size: 0.68rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: none;
    transition:
      transform 220ms cubic-bezier(0.22, 1, 0.36, 1),
      background-color 0.2s ease,
      color 0.2s ease,
      box-shadow 0.2s ease;
  }

  .project-carousel-button--next {
    flex-direction: row-reverse;
  }

  .project-carousel-button__label {
    line-height: 1;
  }

  .project-carousel-button__icon {
    width: 0.86rem;
    height: 0.86rem;
    display: block;
  }

  .project-carousel-button:hover {
    transform: translateY(-1px);
    background: color-mix(
      in oklab,
      var(--site-accent) 18%,
      var(--site-surface)
    );
    color: var(--site-text);
    box-shadow:
      inset 0 0 0 1px color-mix(in oklab, var(--site-accent) 34%, transparent),
      0 8px 16px color-mix(in oklab, var(--site-accent) 12%, transparent);
  }

  .project-carousel-button:active {
    transform: translateY(0);
  }

  .story-carousel-side {
    position: sticky;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    justify-content: flex-start;
    padding: 0 0.75rem;
  }

  .story-carousel-side--right {
    justify-content: flex-end;
  }

  .project-carousel-nav-layer {
    padding-top: clamp(2.4rem, 4.6vw, 3.6rem);
  }

  @media (max-width: 767px) {
    .story-carousel-side {
      display: none;
    }

    .project-carousel-nav-layer {
      padding-top: 0;
    }

    .project-carousel-button {
      --control-height: 1.82rem;
      gap: 0.32rem;
      padding: 0 0.56rem;
      font-size: 0.64rem;
      letter-spacing: 0.04em;
    }

    .project-carousel-button__icon {
      width: 0.8rem;
      height: 0.8rem;
    }
  }

  .project-carousel-hint {
    display: none;
    text-align: center;
    font-size: 0.7rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: color-mix(in oklab, currentColor 55%, transparent);
  }

  @media (max-width: 767px) {
    .project-carousel-hint {
      display: block;
      margin-top: 0.25rem;
    }
  }
</style>
