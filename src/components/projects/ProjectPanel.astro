---
import TagChip from '@/components/ui/TagChip.astro';
import PillLink from '@/components/ui/PillLink.astro';
import ProjectBanner from '@/components/projects/ProjectBanner.astro';
import Prose from '@/components/ui/Prose.astro';
import type { ProjectPanel as ProjectPanelType } from '@/lib/projects';
import { isSafeExternalHref, sanitizeHref, withBase } from '@/lib/urls';

type Props = {
  project: ProjectPanelType;
  index: number;
  total: number;
};

const { project, index, total } = Astro.props as Props;
const { entry, Content } = project;
const { data } = entry;

const linkLabels: Record<string, string> = {
  repo: 'Code',
  live: 'Live',
  paper: 'Paper',
};

const banners = data.banners ?? [];
const bannersAbove = banners.filter((banner) => banner.placement === 'above');
const bannersBelow = banners.filter((banner) => banner.placement === 'below');
const publication = data.publication;

const panelId = `project-${entry.slug}`;
const titleId = `${panelId}-title`;

const normalizeHref = (href: string) => {
  const safeHref = sanitizeHref(href);
  return safeHref.startsWith('/') ? withBase(safeHref) : safeHref;
};

const parseEmphasis = (text: string) =>
  text
    .split(/(\*[^*]+\*)/g)
    .filter(Boolean)
    .map((segment) => {
      const isEmphasis =
        segment.startsWith('*') && segment.endsWith('*') && segment.length > 2;
      return {
        content: isEmphasis ? segment.slice(1, -1) : segment,
        emphasis: isEmphasis,
      };
    });
---

<section
  id={panelId}
  class="w-full min-w-full shrink-0 snap-center md:snap-start"
  role="group"
  aria-roledescription="slide"
  aria-label={`Project ${index + 1} of ${total}: ${data.title}`}
  aria-labelledby={titleId}
  data-project={entry.slug}
  data-carousel-panel
  data-index={index}
>
  <div class="project-panel-scroll">
    <div class="mx-auto flex w-full max-w-3xl flex-col gap-8 px-0 py-8 sm:px-6">
      <header class="space-y-4">
        <div
          class="text-xs font-semibold uppercase tracking-[0.3em] text-base-content/50"
        >
          Project {index + 1} / {total}
        </div>
        <div class="space-y-3">
          <h2 id={titleId} class="text-3xl font-semibold">
            {data.title}
          </h2>
          <p class="text-base-content/80 leading-relaxed">
            {
              parseEmphasis(data.description).map((part) =>
                part.emphasis ? (
                  <em>{part.content}</em>
                ) : (
                  <span>{part.content}</span>
                ),
              )
            }
          </p>
          {
            data.summary && (
              <p class="text-sm text-base-content/60">{data.summary}</p>
            )
          }
        </div>
      </header>

      {
        data.tech.length > 0 && (
          <ul class="flex flex-wrap gap-2">
            {data.tech.map((tag) => (
              <li>
                <TagChip label={tag} size="xs" uppercase />
              </li>
            ))}
          </ul>
        )
      }

      {
        data.links && (
          <div class="flex flex-wrap gap-4 text-sm text-base-content/70 font-sans">
            {Object.entries(data.links).map(([key, href]) =>
              href ? (
                <PillLink href={href}>{linkLabels[key] ?? key}</PillLink>
              ) : null,
            )}
          </div>
        )
      }

      <Prose class="prose-p:text-base-content/80">
        {
          bannersAbove.length > 0 && (
            <div class="not-prose my-8 space-y-6">
              {bannersAbove.map((banner) => (
                <ProjectBanner banner={banner} />
              ))}
            </div>
          )
        }
        <Content />
        {
          bannersBelow.length > 0 && (
            <div class="not-prose my-8 space-y-6">
              {bannersBelow.map((banner) => (
                <ProjectBanner banner={banner} />
              ))}
            </div>
          )
        }
        {
          publication && (
            <p class="text-sm text-base-content/60">
              {publication.label}{' '}
              {publication.links.map((link, linkIndex) => (
                <span>
                  {(() => {
                    const href = normalizeHref(link.href);
                    const isExternalLink = isSafeExternalHref(href);
                    return (
                      <a
                        class="focus-ring text-accent/80 transition hover:text-accent"
                        href={href}
                        target={isExternalLink ? '_blank' : undefined}
                        rel={isExternalLink ? 'noreferrer noopener' : undefined}
                      >
                        {parseEmphasis(link.label).map((part) =>
                          part.emphasis ? (
                            <em>{part.content}</em>
                          ) : (
                            <span>{part.content}</span>
                          ),
                        )}
                      </a>
                    );
                  })()}
                  {linkIndex < publication.links.length - 1 && (
                    <span class="mx-2 text-base-content/30" aria-hidden="true">
                      Â·
                    </span>
                  )}
                </span>
              ))}
            </p>
          )
        }
      </Prose>
    </div>
  </div>
</section>

<style>
  .project-panel-scroll {
    height: auto;
    overflow: visible;
    overscroll-behavior: auto;
    -webkit-overflow-scrolling: touch;
  }

  :global([data-carousel-panel] .prose) {
    --project-media-canvas-padding-inline: 0.72rem;
    --project-media-canvas-padding-block: 0.62rem;
  }

  :global([data-carousel-panel] .prose picture),
  :global([data-carousel-panel] .prose img) {
    display: block;
    inline-size: 100%;
    max-inline-size: 100%;
  }

  :global([data-carousel-panel] .prose img) {
    display: block;
    width: 100%;
    max-width: 100%;
    height: auto;
    object-fit: contain;
    margin: 2rem auto;
    padding-inline: var(--project-media-canvas-padding-inline);
    padding-block: var(--project-media-canvas-padding-block);
    border-radius: 1.25rem;
    background: #fff;
    box-shadow: var(--site-media-depth-shadow);
    box-sizing: border-box;
  }

  @media (min-width: 768px) {
    :global([data-carousel-panel] .prose) {
      --project-media-canvas-padding-inline: 0.98rem;
      --project-media-canvas-padding-block: 0.76rem;
    }
  }
</style>
