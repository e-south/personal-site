---
import { withBase } from '@/lib/urls';
import type { NavItem } from '@/data/navigation';
import ExternalIcon from '@/components/ui/ExternalIcon.astro';

const {
  item,
  currentPath = '',
  class: className = '',
} = Astro.props as {
  item: NavItem;
  currentPath?: string;
  class?: string;
};

const isExternal = item.kind === 'external';
const href = isExternal ? item.href : withBase(item.href);
const normalizePath = (path: string) => {
  const cleaned = path.split('#')[0]?.split('?')[0] ?? '';
  const normalized = cleaned.replace(/\/+$/, '');
  return normalized === '' ? '/' : normalized;
};
const normalizedCurrent = normalizePath(currentPath);
const normalizedHref = normalizePath(href);
const isActive =
  !isExternal &&
  (normalizedCurrent === normalizedHref ||
    (normalizedHref !== '/' &&
      normalizedCurrent.startsWith(`${normalizedHref}/`)));
const baseClass =
  'focus-ring inline-flex items-center gap-1 rounded-[var(--site-radius-control)] px-3 py-1.5 text-[0.95rem] font-black font-inter transition-colors';
const internalClasses =
  'text-base-content/76 hover:text-base-content hover:bg-base-content/8';
const activeClasses = 'nav-active text-base-content font-semibold';
---

{
  isActive ? (
    <span
      aria-current="page"
      class:list={[baseClass, internalClasses, activeClasses, className]}
    >
      {item.label}
    </span>
  ) : (
    <a
      href={href}
      target={isExternal ? '_blank' : undefined}
      rel={isExternal ? 'noreferrer noopener' : undefined}
      class:list={[
        baseClass,
        isExternal ? 'nav-icon' : internalClasses,
        className,
      ]}
      aria-label={isExternal ? item.label : undefined}
    >
      {item.kind === 'external' && item.icon ? (
        <>
          <ExternalIcon name={item.icon} class="h-4 w-4" />
          <span class="sr-only">{item.label}</span>
        </>
      ) : (
        <span>{item.label}</span>
      )}
    </a>
  )
}

<style>
  .nav-active {
    border: 1px solid color-mix(in oklab, var(--site-accent) 42%, transparent);
    background:
      linear-gradient(
        140deg,
        color-mix(in oklab, var(--site-accent) 28%, transparent),
        color-mix(in oklab, var(--site-accent-soft) 26%, transparent)
      ),
      color-mix(in oklab, var(--site-surface) 65%, transparent);
    box-shadow: inset 0 1px 0 color-mix(in oklab, #fff 10%, transparent);
  }
  .nav-icon {
    width: 2.25rem;
    height: 2.25rem;
    padding: 0;
    justify-content: center;
    color: color-mix(in oklab, var(--site-text) 78%, transparent);
  }
  .nav-icon:hover {
    color: var(--site-text);
    background-color: color-mix(in oklab, var(--site-accent) 18%, transparent);
  }
</style>
