---
import Pagination from '@/components/ui/Pagination.astro';
import Layout from '@/layouts/Layout.astro';
import { template } from '@/settings';
import { getBlogListItems } from '@/lib/content';
import { getEntry, render } from 'astro:content';
import type { BlogListItem } from '@/lib/content';
import BlogPostList from '@/components/blog/BlogPostList.astro';
import SubscribeCta from '@/components/ui/SubscribeCta.astro';
import { requireEntry } from '@/lib/require';
import { withBase } from '@/lib/urls';

const posts: BlogListItem[] = await getBlogListItems();
const pageSize = template.postPerPage;
const page = {
  data: posts.slice(0, pageSize),
  url: {
    prev: undefined,
    next: posts.length > pageSize ? withBase('/blog/2') : undefined,
  },
};
const hasPosts = posts.length > 0;

const blogEntry = requireEntry(
  await getEntry('page-blog', 'blog'),
  'page-blog/blog',
);
const { Content } = await render(blogEntry);
const blogData = blogEntry.data;
const title = blogData.title;
const intro = blogData.intro;
---

{
  hasPosts ? (
    <Layout title={title}>
      <div class="mx-auto max-w-3xl space-y-12">
        <header class="space-y-3" data-reveal>
          <h1 class="page-main-header page-main-header--blog text-4xl sm:text-5xl font-semibold">
            {title}
          </h1>
          <p class="text-base-content/70">{intro}</p>
        </header>

        <div data-reveal>
          <SubscribeCta />
        </div>

        <BlogPostList
          posts={page.data}
          articleClass="glass-card space-y-3 p-6"
          reveal
        />

        <div class="flex justify-center">
          <Pagination page={page} />
        </div>
      </div>
    </Layout>
  ) : (
    <Layout title={title}>
      <div class="mx-auto max-w-3xl space-y-12">
        <header class="space-y-3" data-reveal>
          <h1 class="page-main-header page-main-header--blog text-4xl sm:text-5xl font-semibold">
            {title}
          </h1>
          <p class="text-base-content/70">{intro}</p>
        </header>

        <div data-reveal>
          <SubscribeCta />
        </div>

        {Content && (
          <div class="text-base-content/70 leading-relaxed" data-reveal>
            <Content />
          </div>
        )}
      </div>
    </Layout>
  )
}
