---
import Layout from '@/layouts/Layout.astro';
import { Image } from 'astro:assets';
import { render } from 'astro:content';
import { getPublishedBlogEntries } from '@/lib/content';
import { formatLongDate } from '@/lib/dates';
import Prose from '@/components/ui/Prose.astro';
import TagChip from '@/components/ui/TagChip.astro';
import SubscribeCta from '@/components/ui/SubscribeCta.astro';
import { analytics } from '@/settings';

export async function getStaticPaths() {
  const posts = await getPublishedBlogEntries();

  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}
const { post } = Astro.props;
const { title, date, tags } = post.data;
const { Content } = await render(post);
const showViewCounts =
  analytics.showViewCounts && Boolean(analytics.goatcounterEndpoint);
---

<Layout title={title}>
  <div class="max-w-4xl mx-auto">
    <article class="space-y-8" data-email-root>
      <!-- Header section -->
      <div class="mb-8 border-b pb-8">
        <h1 class="text-4xl font-bold mb-4 text-base-content">{title}</h1>
        <div class="flex flex-wrap items-center gap-4 text-base-content/70">
          <!-- Date -->
          <time datetime={date.toISOString()} class="flex items-center">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4 mr-2"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
              ></path>
            </svg>
            {formatLongDate(date)}
          </time>

          <!-- Tags -->
          {
            tags.length > 0 && (
              <div class="flex flex-wrap gap-2">
                {tags.map((tag) => (
                  <TagChip label={tag} size="xs" />
                ))}
              </div>
            )
          }
          {
            showViewCounts && (
              <div class="text-xs uppercase tracking-[0.2em] text-base-content/50">
                Views: <span data-view-count>â€”</span>
              </div>
            )
          }
        </div>
      </div>
      {/* Optional cover image */}
      {
        post.data.cover && (
          <Image
            src={post.data.cover}
            alt={post.data.coverAlt ?? title}
            class="rounded-lg mb-8 w-full aspect-video object-cover"
          />
        )
      }
      <!-- Post content -->
      <Prose class="mt-2">
        <Content />
      </Prose>
    </article>

    <div class="mt-12">
      <SubscribeCta />
    </div>
  </div>
</Layout>

<script is:inline define:vars={{ showViewCounts }}>
  if (showViewCounts) {
    const viewCount = document.querySelector('[data-view-count]');
    const renderCounts = () => {
      const goatcounter = window.goatcounter;
      if (
        !viewCount ||
        !goatcounter ||
        typeof goatcounter.visit_count !== 'function'
      ) {
        return;
      }
      goatcounter.visit_count({
        append: viewCount,
        no_branding: true,
      });
    };
    if (document.readyState === 'complete') {
      renderCounts();
    } else {
      window.addEventListener('load', renderCounts, { once: true });
    }
  }
</script>
