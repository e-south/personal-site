---
import Layout from '@/layouts/Layout.astro';
import { withBase } from '@/lib/urls';
import { getEntry } from 'astro:content';
import { existsSync } from 'node:fs';
import path from 'node:path';
import PillLink from '@/components/ui/PillLink.astro';
import { requireEntry } from '@/lib/require';

const cvEntry = requireEntry(await getEntry('cv', 'cv'), 'cv/cv');
const pageEntry = requireEntry(await getEntry('page-cv', 'cv'), 'page-cv/cv');
const updated =
  cvEntry.data.updated &&
  cvEntry.data.updated.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
const pageData = pageEntry.data;
const title = pageData.title;
const intro = pageData.intro;
const downloadLabel = pageData.downloadLabel;
const introLine = (() => {
  if (!updated) return intro;
  const trimmed = intro.trim();
  const endsWithPunctuation = /[.!?]$/.test(trimmed);
  const base = endsWithPunctuation ? trimmed : `${trimmed}.`;
  return `${base} Updated ${updated}.`;
})();

const normalizeCvPath = (value: string) => {
  if (!value || typeof value !== 'string') return null;
  const trimmed = value.trim();
  if (!trimmed) return null;
  const normalized = trimmed.startsWith('/') ? trimmed : `/cv/${trimmed}`;
  const fsPath = path.join(process.cwd(), 'public', normalized.slice(1));
  return {
    url: withBase(normalized),
    fsPath,
  };
};

const configuredPdf = normalizeCvPath(pageData?.cvPdf);
if (!configuredPdf) {
  throw new Error('[cv] cvPdf is required in page-cv content.');
}
if (!existsSync(configuredPdf.fsPath)) {
  throw new Error(`[cv] Configured PDF not found at ${configuredPdf.fsPath}`);
}
const cvPath = configuredPdf.url;
---

<Layout title={title}>
  <div class="mx-auto w-full max-w-4xl space-y-10">
    <header class="space-y-3" data-reveal>
      <h1 class="text-4xl sm:text-5xl font-semibold">{title}</h1>
      <p class="text-base-content/70">{introLine}</p>
    </header>

    <div class="space-y-4" data-reveal>
      <div class="glass-card rounded-2xl p-4">
        <iframe src={cvPath} title="CV PDF" class="h-[70vh] w-full rounded-xl"
        ></iframe>
      </div>
      <div class="flex justify-center">
        <PillLink
          href={cvPath}
          variant="pastel"
          class="rounded-[var(--site-radius-control)] px-6 py-2 text-[0.7rem] uppercase tracking-[0.2em]"
        >
          {downloadLabel}
        </PillLink>
      </div>
    </div>
  </div>
</Layout>
