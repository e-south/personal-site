---
import Layout from '../layouts/Layout.astro';

import { heroImages } from '@/data/heroImages';
import { storyRegistry } from '@/data/storyMedia';
import PillLink from '@/components/ui/PillLink.astro';
import HomeController from '@/components/home/HomeController';
import StoryChapters from '@/components/home/StoryChapters.astro';
import { getCollection, getEntry } from 'astro:content';
import { requireEntry } from '@/lib/require';

const homeEntry = requireEntry(await getEntry('home', 'home'), 'home/home');
const storyEntries = await getCollection('story');
if (storyEntries.length === 0) {
  throw new Error('Story chapters are missing.');
}

const homeData = homeEntry.data;
const name = homeData.name;
const headline = homeData.headline ?? '';
const locationLine = homeData.locationLine;
const overview = homeData.overview;

const heroItems = heroImages.map((item) => ({
  src: item.image.src,
  alt: item.alt,
  caption: item.caption,
}));
const heroFirst = heroImages[0];
---

<Layout showFooter={false}>
  <section id="top" class="space-y-16" data-story-top>
    <div class="flex min-h-[calc(100vh-9rem)] flex-col gap-10">
      <div class="grid gap-10 lg:grid-cols-[1.15fr_0.85fr] lg:items-center">
        <div class="space-y-6">
          <div class="space-y-3">
            {
              locationLine && (
                <p class="text-sm uppercase tracking-[0.2em] text-base-content/60 font-sans">
                  {locationLine}
                </p>
              )
            }
            <h1 class="text-4xl sm:text-5xl font-semibold tracking-tight">
              {name}
            </h1>
            {
              headline && (
                <h2 class="text-2xl sm:text-3xl text-base-content/80">
                  {headline}
                </h2>
              )
            }
          </div>
          {
            overview && (
              <p
                class="text-lg text-base-content/80 leading-relaxed text-justify"
                set:html={overview}
              />
            )
          }
        </div>

        <div class="order-first lg:order-none">
          <div class="mx-auto max-w-xs" data-hero-shell>
            <div class="relative overflow-hidden rounded-3xl">
              <figure
                class="relative"
                data-hero-rotator
                data-images={JSON.stringify(heroItems)}
                data-interval="6500"
              >
                <img
                  src={heroFirst.image.src}
                  alt={heroFirst.alt}
                  width={heroFirst.image.width}
                  height={heroFirst.image.height}
                  class="aspect-[4/5] w-full object-cover transition-opacity duration-500 ease-out"
                  loading="eager"
                  decoding="async"
                  data-hero-image
                />
                <figcaption
                  class="pointer-events-none absolute bottom-3 left-1/2 w-[90%] -translate-x-1/2 rounded-2xl bg-black/45 px-3 py-1.5 text-center text-[0.7rem] leading-snug text-white/90 backdrop-blur-sm transition-opacity duration-500 ease-out"
                  data-hero-caption
                  data-empty={heroFirst.caption ? 'false' : 'true'}
                  aria-hidden={heroFirst.caption ? 'false' : 'true'}
                >
                  {heroFirst.caption}
                </figcaption>
              </figure>
            </div>
            {
              heroItems.length > 1 && (
                <div
                  class="mt-3 flex justify-center gap-2 text-base-content/70"
                  data-hero-dots
                  aria-label="Hero image selection"
                >
                  {heroItems.map((_, index) => (
                    <button
                      type="button"
                      class="hero-dot"
                      data-hero-dot
                      data-hero-index={index}
                      aria-label={`Show image ${index + 1}`}
                      aria-current={index === 0 ? 'true' : 'false'}
                    />
                  ))}
                </div>
              )
            }
          </div>
        </div>
      </div>

      <div class="flex justify-center -mt-4">
        <PillLink
          href="#about"
          variant="pastel"
          class="border-transparent px-6 py-2 text-[0.7rem] uppercase tracking-[0.25em]"
          data-scroll-link
        >
          More about me
        </PillLink>
      </div>
    </div>

    <StoryChapters chapters={storyEntries} registry={storyRegistry} />
  </section>

  <HomeController client:load />

  <style>
    [data-hero-rotator].is-fading [data-hero-image],
    [data-hero-rotator].is-fading [data-hero-caption] {
      opacity: 0;
    }

    [data-hero-caption][data-empty='true'] {
      opacity: 0;
    }

    [data-hero-dot] {
      height: 0.5rem;
      width: 0.5rem;
      border-radius: 9999px;
      background-color: currentColor;
      opacity: 0.25;
      transition:
        opacity 200ms ease-out,
        transform 200ms ease-out;
    }

    [data-hero-dot][aria-current='true'] {
      opacity: 0.8;
      transform: scale(1.08);
    }

    [data-hero-dot]:focus-visible {
      outline: 2px solid currentColor;
      outline-offset: 3px;
    }

    :global(html.story-snap) [data-story-top] {
      scroll-snap-align: start;
    }
  </style>
</Layout>
