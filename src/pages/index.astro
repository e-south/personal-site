---
/*
--------------------------------------------------------------------------------
personal-site
src/pages/index.astro

Renders the home page layout and hero rotator.

Module Author(s): Eric J. South
--------------------------------------------------------------------------------
*/

import Layout from '../layouts/Layout.astro';

import type { ImageMetadata } from 'astro';
import { heroImages } from '@/data/heroImages';
import { storyRegistry } from '@/data/storyMedia';
import PillLink from '@/components/ui/PillLink.astro';
import StoryChapters from '@/components/home/StoryChapters.astro';
import SubscribeCta from '@/components/ui/SubscribeCta.astro';
import { getImage } from 'astro:assets';
import { getCollection, getEntry } from 'astro:content';
import { requireEntry } from '@/lib/require';

const homeEntry = requireEntry(await getEntry('home', 'home'), 'home/home');
const storyEntries = await getCollection('story');
if (storyEntries.length === 0) {
  throw new Error('Story chapters are missing.');
}

const homeData = homeEntry.data;
const name = homeData.name;
const headline = homeData.headline ?? '';
const locationLine = homeData.locationLine;
const overview = homeData.overview;

const parseOverviewSegments = (text: string) =>
  text
    .split(/(<em>[^<]+<\/em>)/g)
    .filter(Boolean)
    .map((segment) => {
      const match = segment.match(/^<em>([^<]+)<\/em>$/);
      if (!match) {
        return {
          content: segment,
          emphasis: false,
        };
      }
      return {
        content: match[1],
        emphasis: true,
      };
    });

const heroBaseWidth = 320;
const heroContainerAspect = 4 / 5;
const heroWidths = [320, 480, 640, 800, 960, 1280];
const getHeroCoverWidth = (image: ImageMetadata) => {
  const imageAspect = image.width / image.height;
  const coverScale =
    imageAspect > heroContainerAspect ? imageAspect / heroContainerAspect : 1;
  return Math.round(heroBaseWidth * coverScale);
};
const heroImageVariants = await Promise.all(
  heroImages.map(async (item) => {
    const coverWidth = getHeroCoverWidth(item.image);
    const sizes = `${coverWidth}px`;
    const optimized = await getImage({
      src: item.image,
      widths: heroWidths,
      sizes,
    });
    return {
      image: optimized,
      alt: item.alt,
      caption: item.caption,
      sizes,
    };
  }),
);

const heroItems = heroImageVariants.map((item) => ({
  src: item.image.src,
  srcset: item.image.srcSet.attribute,
  sizes: item.image.attributes.sizes ?? item.sizes,
  width: item.image.attributes.width,
  height: item.image.attributes.height,
  alt: item.alt,
  caption: item.caption,
}));
const heroFirst = heroImageVariants[0];
---

<Layout showFooter={false}>
  <section id="top" class="space-y-16" data-story-top>
    <div class="flex min-h-[calc(100vh-9rem)] flex-col gap-10">
      <div class="grid gap-10 lg:grid-cols-[1.15fr_0.85fr] lg:items-center">
        <div class="space-y-6" data-reveal>
          <div class="space-y-3">
            {
              locationLine && (
                <p class="text-sm uppercase tracking-[0.2em] text-base-content/60 font-sans">
                  {locationLine}
                </p>
              )
            }
            <h1
              class="page-main-header page-main-header--home text-4xl sm:text-5xl font-semibold tracking-tight"
            >
              {name}
            </h1>
            {
              headline && (
                <h2 class="text-2xl sm:text-3xl text-base-content/80">
                  {headline}
                </h2>
              )
            }
          </div>
          {
            overview && (
              <p class="text-lg text-base-content/80 leading-relaxed text-justify">
                {parseOverviewSegments(overview).map((part) =>
                  part.emphasis ? (
                    <em>{part.content}</em>
                  ) : (
                    <span>{part.content}</span>
                  ),
                )}
              </p>
            )
          }
        </div>

        <div
          class="order-first space-y-5 lg:order-none"
          data-home-hero-secondary
          data-reveal
        >
          <div class="mx-auto max-w-xs" data-hero-shell>
            <div
              class="home-hero-image-shell relative overflow-hidden rounded-3xl"
            >
              <figure
                class="relative"
                data-hero-rotator
                data-images={JSON.stringify(heroItems)}
                data-interval="6500"
              >
                <img
                  src={heroFirst.image.src}
                  srcset={heroFirst.image.srcSet.attribute}
                  sizes={heroFirst.image.attributes.sizes ?? heroFirst.sizes}
                  alt={heroFirst.alt}
                  width={heroFirst.image.attributes.width}
                  height={heroFirst.image.attributes.height}
                  class="aspect-[4/5] w-full object-cover transition-opacity duration-500 ease-out"
                  loading="eager"
                  decoding="async"
                  data-hero-image
                />
                <figcaption
                  class="pointer-events-none absolute bottom-3 left-1/2 w-[90%] -translate-x-1/2 rounded-2xl liquid-caption px-3 py-1.5 text-center text-[0.7rem] leading-snug transition-opacity duration-500 ease-out"
                  data-hero-caption
                  data-empty={heroFirst.caption ? 'false' : 'true'}
                  aria-hidden={heroFirst.caption ? 'false' : 'true'}
                >
                  {heroFirst.caption}
                </figcaption>
              </figure>
            </div>
            {
              heroItems.length > 1 && (
                <div
                  class="mt-3 flex justify-center gap-2 text-base-content/70"
                  data-hero-dots
                  aria-label="Hero image selection"
                >
                  {heroItems.map((_, index) => (
                    <button
                      type="button"
                      class="hero-dot focus-ring"
                      data-hero-dot
                      data-hero-index={index}
                      aria-label={`Show image ${index + 1}`}
                      aria-current={index === 0 ? 'true' : 'false'}
                    />
                  ))}
                </div>
              )
            }
          </div>
          <SubscribeCta class="mx-auto w-full max-w-md" />
        </div>
      </div>

      <div class="flex justify-center -mt-4" data-reveal>
        <PillLink
          href="#about"
          variant="pastel"
          class="border-transparent px-6 py-2 text-[0.7rem] uppercase tracking-[0.25em]"
          data-scroll-link
        >
          More about me
        </PillLink>
      </div>
    </div>

    <StoryChapters chapters={storyEntries} registry={storyRegistry} />
  </section>

  <script>
    import { initHomePage } from '@/lib/home';

    initHomePage();
  </script>

  <style>
    [data-hero-rotator] {
      touch-action: pan-y;
    }

    [data-hero-rotator].is-fading [data-hero-image],
    [data-hero-rotator].is-fading [data-hero-caption] {
      opacity: 0;
    }

    [data-hero-caption][data-empty='true'] {
      opacity: 0;
    }

    [data-hero-dot] {
      height: 0.5rem;
      width: 0.5rem;
      border-radius: 9999px;
      background-color: currentColor;
      opacity: 0.25;
      transition:
        opacity 200ms ease-out,
        transform 200ms ease-out;
    }

    [data-hero-dot][aria-current='true'] {
      opacity: 0.8;
      transform: scale(1.08);
    }

    .home-hero-image-shell {
      position: relative;
      isolation: isolate;
      box-shadow:
        var(--site-shadow-1),
        var(--site-shadow-2),
        0 24px 42px color-mix(in oklab, #000 32%, transparent);
    }

    .home-hero-image-shell::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      pointer-events: none;
      box-shadow:
        inset 0 1px 0 color-mix(in oklab, #fff 24%, transparent),
        inset 0 -26px 30px color-mix(in oklab, #000 26%, transparent);
    }

    [data-hero-image] {
      transform: scale(1.01);
      transform-origin: center;
    }

    :global(html.story-snap) [data-story-top] {
      scroll-snap-align: start;
    }
  </style>
</Layout>
